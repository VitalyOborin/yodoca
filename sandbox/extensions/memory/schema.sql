-- ==========================================================================\n-- Memory v2: Graph-based cognitive memory (ADR 008)\n-- ==========================================================================\n\n-- ==========================================================================\n-- Nodes: memory atoms (episodes, facts, procedures, opinions)\n-- ==========================================================================\nCREATE TABLE IF NOT EXISTS nodes (\n    id               TEXT PRIMARY KEY,\n    type             TEXT NOT NULL CHECK(type IN ('episodic','semantic','procedural','opinion')),\n    content          TEXT NOT NULL,\n    embedding        BLOB,\n\n    -- Bi-temporal: event time + validity interval\n    event_time       INTEGER NOT NULL,    -- when the event actually occurred\n    created_at       INTEGER NOT NULL,    -- when recorded in DB (ingestion time)\n    valid_from       INTEGER NOT NULL,    -- start of fact validity\n    valid_until      INTEGER,             -- NULL = still valid (soft-delete sets this)\n\n    -- Confidence and lifecycle\n    confidence       REAL NOT NULL DEFAULT 1.0,\n    access_count     INTEGER NOT NULL DEFAULT 0,\n    last_accessed    INTEGER,\n    decay_rate       REAL NOT NULL DEFAULT 0.1,\n\n    -- Provenance\n    source_type      TEXT,     -- conversation | tool_result | extraction | consolidation\n    source_role      TEXT,     -- user | orchestrator | <agent_id>\n    session_id       TEXT,     -- links episodic nodes to their conversation session\n\n    -- Extensible metadata\n    attributes       TEXT DEFAULT '{}'\n);\n\n-- ==========================================================================\n-- Edges: typed relationships between nodes\n-- ==========================================================================\nCREATE TABLE IF NOT EXISTS edges (\n    id               TEXT PRIMARY KEY,\n    source_id        TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n    target_id        TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n\n    relation_type    TEXT NOT NULL CHECK(relation_type IN\n        ('temporal','causal','entity','derived_from','supersedes')),\n    predicate        TEXT,               -- human-readable label (e.g. \"works_at\", \"caused_by\")\n    weight           REAL NOT NULL DEFAULT 1.0,\n    confidence       REAL NOT NULL DEFAULT 1.0,\n\n    valid_from       INTEGER NOT NULL,\n    valid_until      INTEGER,\n\n    evidence         TEXT DEFAULT '[]',  -- JSON: supporting episode node IDs\n\n    created_at       INTEGER NOT NULL\n);\n\n-- ==========================================================================\n-- Entity anchors: canonical identities for real-world entities\n-- ==========================================================================\nCREATE TABLE IF NOT EXISTS entities (\n    id               TEXT PRIMARY KEY,\n    canonical_name   TEXT NOT NULL,\n    type             TEXT NOT NULL CHECK(type IN\n        ('person','project','organization','place','concept','tool')),\n    aliases          TEXT DEFAULT '[]',   -- JSON: [\"Sasha\", \"my boss\", \"Alex\"]\n    summary          TEXT,                -- LLM-generated entity description\n    embedding        BLOB,\n    first_seen       INTEGER NOT NULL,\n    last_updated     INTEGER NOT NULL,\n    mention_count    INTEGER NOT NULL DEFAULT 1,\n    attributes       TEXT DEFAULT '{}'\n);\n\n-- Node-entity junction table (indexed for fast entity-based queries)\nCREATE TABLE IF NOT EXISTS node_entities (\n    node_id    TEXT NOT NULL REFERENCES nodes(id) ON DELETE CASCADE,\n    entity_id  TEXT NOT NULL REFERENCES entities(id) ON DELETE CASCADE,\n    PRIMARY KEY (node_id, entity_id)\n);\nCREATE INDEX IF NOT EXISTS idx_ne_entity ON node_entities(entity_id);\n\n-- ==========================================================================\n-- Maintenance timestamps (persisted so script-run maintenance is visible to supervisor)\n-- ==========================================================================\nCREATE TABLE IF NOT EXISTS maintenance_metadata (\n    key   TEXT PRIMARY KEY,\n    value TEXT NOT NULL\n);\n\n-- ==========================================================================\n-- Session consolidation tracking\n-- ==========================================================================\nCREATE TABLE IF NOT EXISTS sessions_consolidations (\n    session_id       TEXT PRIMARY KEY,\n    first_seen_at    INTEGER NOT NULL,\n    consolidated_at  INTEGER\n);\n\n-- ==========================================================================\n-- Performance indexes\n-- ==========================================================================\nCREATE INDEX IF NOT EXISTS idx_nodes_type ON nodes(type);\nCREATE INDEX IF NOT EXISTS idx_nodes_event_time ON nodes(event_time);\nCREATE INDEX IF NOT EXISTS idx_nodes_valid ON nodes(valid_from, valid_until);\nCREATE INDEX IF NOT EXISTS idx_nodes_confidence ON nodes(confidence);\nCREATE INDEX IF NOT EXISTS idx_nodes_session ON nodes(session_id);\nCREATE INDEX IF NOT EXISTS idx_edges_relation ON edges(relation_type);\nCREATE INDEX IF NOT EXISTS idx_edges_source ON edges(source_id);\nCREATE INDEX IF NOT EXISTS idx_edges_target ON edges(target_id);\nCREATE INDEX IF NOT EXISTS idx_edges_valid ON edges(valid_from, valid_until);\nCREATE INDEX IF NOT EXISTS idx_entities_type ON entities(type);\nCREATE INDEX IF NOT EXISTS idx_entities_name ON entities(canonical_name);\n\n-- ==========================================================================\n-- Full-text search (FTS5, built-in)\n-- ==========================================================================\nCREATE VIRTUAL TABLE IF NOT EXISTS nodes_fts USING fts5(\n    content,\n    content=nodes,\n    content_rowid=rowid,\n    tokenize='unicode61'\n);\n\nCREATE TRIGGER IF NOT EXISTS nodes_fts_insert AFTER INSERT ON nodes BEGIN\n    INSERT INTO nodes_fts(rowid, content) VALUES (new.rowid, new.content);\nEND;\n\nCREATE TRIGGER IF NOT EXISTS nodes_fts_update AFTER UPDATE OF content ON nodes BEGIN\n    INSERT INTO nodes_fts(nodes_fts, rowid, content)\n        VALUES ('delete', old.rowid, old.content);\n    INSERT INTO nodes_fts(rowid, content) VALUES (new.rowid, new.content);\nEND;\n\nCREATE TRIGGER IF NOT EXISTS nodes_fts_delete AFTER DELETE ON nodes BEGIN\n    INSERT INTO nodes_fts(nodes_fts, rowid, content)\n        VALUES ('delete', old.rowid, old.content);\nEND;\n\n-- ==========================================================================\n-- Vector search (sqlite-vec, optional)\n-- ==========================================================================\nCREATE VIRTUAL TABLE IF NOT EXISTS vec_nodes USING vec0(\n    node_id TEXT PRIMARY KEY,\n    embedding float[1024]\n);\n\nCREATE VIRTUAL TABLE IF NOT EXISTS vec_entities USING vec0(\n    entity_id TEXT PRIMARY KEY,\n    embedding float[1024]\n);\n